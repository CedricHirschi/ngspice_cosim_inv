<!DOCTYPE html>

</html>
<style>
    body {
        font: 14px/1.4 system-ui, sans-serif;
        max-width: 960px;
        margin: 24px auto;
        padding: 0 12px;
    }

    .row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
    }

    .pad {
        margin: 8px 0;
    }

    textarea {
        width: 100%;
        height: 160px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }

    pre {
        background: #0b1020;
        color: #cfe3ff;
        padding: 12px;
        overflow: auto;
        min-height: 120px;
        max-height: 120px;
    }

    .badge {
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid #ccc;
    }

    .idle {
        background: #eef;
    }

    .running {
        background: #ffe;
    }

    .alive {
        background: #efe;
    }

    .warn {
        background: #ffe3cc;
    }

    .err {
        background: #ffd6d6;
    }

    .term {
        background: #eee;
        color: #666;
    }

    button {
        padding: 6px 10px;
    }

    code {
        background: #f5f5f5;
        padding: 0 4px;
        border-radius: 4px;
    }

    label b {
        display: block;
        margin-bottom: 4px;
    }

    #files ul {
        padding-left: 18px;
    }

    #files li {
        margin: 6px 0;
    }

    #files pre {
        margin-top: 6px;
    }
</style>
</head>

<body>
    <h1>YoWASP-Yosys in the browser (Web Worker + Status)</h1>

    <div class="pad">
        <div class="row">
            <div>Status: <span id="status" class="badge idle">Idle</span></div>
            <div>Last heartbeat: <code id="lastbeat">—</code></div>
        </div>
    </div>

    <div class="pad">
        <label for="verilog"><b>Verilog source (saved as <code>top.v</code>)</b></label>
        <textarea id="verilog">module top(input a, input b, output y);
  assign y = a & b;
endmodule
</textarea>
    </div>

    <div class="pad">
        <label for="passes"><b>Yosys passes (-p "...")</b></label>
        <textarea
            id="passes">hierarchy -auto-top; proc; opt; stat; write_json out.json; write_verilog -noattr out.v</textarea>
    </div>

    <div class="pad row">
        <button id="runBtn">Run Yosys</button>
        <button id="pingBtn">Ping</button>
        <button id="stopBtn">Terminate Worker</button>
        <button id="newBtn">New Worker</button>
    </div>

    <div class="pad">
        <b>Log</b>
        <pre id="log"></pre>
    </div>

    <div class="pad">
        <b>Files</b>
        <div id="files">(none)</div>
    </div>

    <script type="module">
        // --- Config ---
        const CDN = 'https://cdn.jsdelivr.net/npm/@yowasp/yosys/gen/bundle.js';
        const HEARTBEAT_MS = 2000;
        const STALE_MS = 5000;

        // --- UI helpers ---
        const $status = document.getElementById('status');
        const $lastbeat = document.getElementById('lastbeat');
        const $log = document.getElementById('log');
        const $files = document.getElementById('files');

        const setStatus = (txt, cls) => { $status.textContent = txt; $status.className = `badge ${cls}`; };
        const log = (...args) => {
            const line = args.map(v => typeof v === 'string' ? v : JSON.stringify(v, null, 2)).join(' ');
            $log.textContent += line + '\n'; $log.scrollTop = $log.scrollHeight;
        };

        // Render downloadable files with previews
        function renderFiles(filesOut) {
            $files.innerHTML = '';
            const entries = Object.entries(filesOut || {});
            if (!entries.length) { $files.textContent = '(none)'; return; }
            const ul = document.createElement('ul');

            for (const [name, bytes] of entries) {
                const u8 = bytes instanceof Uint8Array ? bytes : new Uint8Array(bytes);
                const blob = new Blob([u8], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);

                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = url; a.download = name; a.textContent = `⬇ ${name} (${u8.length} bytes)`;
                li.appendChild(a);

                // Inline preview for small text-like files
                if (/\.(v|sv|json|txt|blif|il|ys)$/i.test(name) && u8.length < 200_000) {
                    try {
                        const text = new TextDecoder().decode(u8);
                        const pre = document.createElement('pre');
                        pre.textContent = text;
                        li.appendChild(pre);
                    } catch { }
                }

                ul.appendChild(li);
            }
            $files.appendChild(ul);
        }

        // --- Worker factory (module worker via Blob) ---
        function createWorker() {
            const workerCode = `
      import { runYosys, Exit } from '${CDN}';
      let busy = false;
      const decoder = new TextDecoder();
      const collect = () => { const lines = []; const push = (b) => { if (b && b.length) lines.push(decoder.decode(b)); }; return { lines, push }; };
      self.postMessage({ type: 'status', state: 'ready' });

      self.onmessage = async (e) => {
        const msg = e.data;
        if (msg?.type === 'ping') { self.postMessage({ type: 'status', state: 'alive', t: Date.now() }); return; }
        if (msg?.type === 'run') {
          if (busy) { self.postMessage({ type: 'status', state: 'busy' }); return; }
          busy = true; self.postMessage({ type: 'status', state: 'running' });
          try {
            const filesIn = { 'top.v': msg.verilog ?? 'module top(input a,b,output y); assign y=a&b; endmodule\\n' };
            const passes = msg.passes ?? 'hierarchy -auto-top; proc; opt; stat; write_json out.json; write_verilog -noattr out.v';
            const argv = ['-p', 'read_verilog top.v; ' + passes];

            const out = collect(), err = collect();
            const filesOut = await runYosys(argv, filesIn, { stdout: out.push, stderr: err.push, decodeASCII: false });

            const text = [
              '--- Yosys stdout ---', out.lines.join(''),
              '--- Yosys stderr ---', err.lines.join(''),
              '--- Files out ---', Object.keys(filesOut || {}).join(', ') || '(none)'
            ].join('\\n');

            self.postMessage({ type: 'result', ok: true, data: text, filesOut });
            self.postMessage({ type: 'status', state: 'idle' });
          } catch (e) {
            if (e instanceof Exit) self.postMessage({ type: 'result', ok: false, error: 'Yosys exited with code ' + e.code });
            else self.postMessage({ type: 'result', ok: false, error: String(e?.message || e) });
            self.postMessage({ type: 'status', state: 'error' });
          } finally { busy = false; }
        }
      };

      self.onerror = (e) => {
        self.postMessage({ type: 'result', ok: false, error: 'Worker error: ' + e.message });
        self.postMessage({ type: 'status', state: 'error' });
      };
    `;
            const url = URL.createObjectURL(new Blob([workerCode], { type: 'text/javascript' }));
            const w = new Worker(url, { type: 'module' });
            URL.revokeObjectURL(url);
            return w;
        }

        // --- State ---
        let worker = null;
        let heartbeatTimer = null;
        let lastBeat = 0;

        function startHeartbeat() {
            stopHeartbeat();
            heartbeatTimer = setInterval(() => {
                if (!worker) return;
                if (lastBeat && (Date.now() - lastBeat > STALE_MS)) setStatus('Unresponsive', 'warn');
                worker.postMessage({ type: 'ping' });
            }, HEARTBEAT_MS);
        }
        function stopHeartbeat() { if (heartbeatTimer) clearInterval(heartbeatTimer); heartbeatTimer = null; }

        function attachWorkerEvents(w) {
            w.onmessage = (e) => {
                const { type } = e.data || {};
                if (type === 'status') {
                    const { state, t } = e.data;
                    if (state === 'ready') { setStatus('Idle', 'idle'); log('[status] ready'); }
                    else if (state === 'alive') { lastBeat = t || Date.now(); $lastbeat.textContent = new Date(lastBeat).toLocaleTimeString(); if ($status.textContent !== 'Running') setStatus('Alive', 'alive'); }
                    else if (state === 'running') setStatus('Running', 'running');
                    else if (state === 'idle') setStatus('Idle', 'idle');
                    else if (state === 'busy') log('[status] busy (ignored run)');
                    else if (state === 'error') setStatus('Error', 'err');
                    return;
                }
                if (type === 'result') {
                    if (e.data.ok) {
                        log(e.data.data);
                        renderFiles(e.data.filesOut);   // <-- show downloadable files
                    } else {
                        log('! Error: ' + e.data.error);
                    }
                    return;
                }
                log('[message]', e.data);
            };
            w.onerror = (err) => { setStatus('Error', 'err'); log('! Worker error:', err.message || err); };
            w.onmessageerror = (err) => { setStatus('Error', 'err'); log('! Worker message error (clone failed):', err.message || err); };
        }

        function ensureWorker() {
            if (worker) return worker;
            worker = createWorker();
            attachWorkerEvents(worker);
            startHeartbeat();
            return worker;
        }

        function terminateWorker() {
            if (worker) {
                worker.terminate(); worker = null; stopHeartbeat();
                setStatus('Terminated', 'term'); log('[worker] terminated');
            }
        }

        // --- UI wiring ---
        document.getElementById('runBtn').onclick = () => {
            const w = ensureWorker();
            const verilog = document.getElementById('verilog').value;
            const passes = document.getElementById('passes').value;
            $log.textContent += '>> Running Yosys...\n';
            w.postMessage({ type: 'run', verilog, passes });
        };
        document.getElementById('pingBtn').onclick = () => { const w = ensureWorker(); w.postMessage({ type: 'ping' }); };
        document.getElementById('stopBtn').onclick = () => { terminateWorker(); };
        document.getElementById('newBtn').onclick = () => { terminateWorker(); ensureWorker(); };

        // Boot with a worker ready
        ensureWorker();
    </script>
</body>

</html>